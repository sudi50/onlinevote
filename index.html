<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Voting OSIS & MPK Sekolah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f8fafc; }
    .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">

  <div id="main" class="w-full max-w-2xl text-center">
    <h1 class="text-2xl font-bold mb-6">E-Voting OSIS & MPK Sekolah</h1>

    <!-- Halaman awal -->
    <div id="menu-awal" class="card">
      <p class="mb-4 text-gray-700">Pilih mode untuk melanjutkan:</p>
      <button onclick="bukaAdmin()" class="btn bg-blue-600 text-white hover:bg-blue-700 w-full mb-2">Masuk sebagai Admin</button>
      <button onclick="bukaPemilih()" class="btn bg-green-600 text-white hover:bg-green-700 w-full">Masuk sebagai Pemilih</button>
    </div>

    <!-- Panel Admin -->
    <div id="panel-admin" class="hidden card text-left">
      <h2 class="text-xl font-semibold mb-4">Panel Admin ‚Äî Setup</h2>

      <h3 class="font-bold text-gray-700 mb-2">Kandidat OSIS</h3>
      <div id="list-osis" class="space-y-2 mb-4"></div>
      <button onclick="tambahOSIS()" class="btn bg-blue-500 text-white">Tambah OSIS</button>

      <h3 class="font-bold text-gray-700 mt-4 mb-2">Kandidat MPK</h3>
      <div id="list-mpk" class="space-y-2 mb-4"></div>
      <button onclick="tambahMPK()" class="btn bg-green-500 text-white">Tambah MPK</button>

      <h3 class="font-bold text-gray-700 mt-4 mb-2">Daftar Pemilih</h3>
      <div id="list-pemilih" class="space-y-2 mb-4"></div>
      <button onclick="tambahPemilih()" class="btn bg-purple-500 text-white">Tambah Pemilih</button>

      <div class="flex flex-col mt-6 space-y-2">
        <button onclick="simpanSetup()" class="btn bg-indigo-600 text-white">üíæ Simpan Setup (Server & Lokal)</button>
        <button onclick="importDataServer()" class="btn bg-teal-600 text-white">üîÑ Import dari Server</button>
        <button onclick="kembaliMenu()" class="btn bg-gray-300">Kembali</button>
      </div>
    </div>

    <!-- Panel Pemilih -->
    <div id="panel-pemilih" class="hidden card text-left">
      <h2 class="text-xl font-semibold mb-4">Masukkan Kode Voting</h2>
      <input id="kode-voting" type="text" placeholder="Kode Voting" class="border p-2 w-full rounded mb-3">
      <button onclick="loginPemilih()" class="btn bg-green-600 text-white w-full">Masuk</button>
      <button onclick="kembaliMenu()" class="btn bg-gray-300 mt-2 w-full">Kembali</button>
    </div>

    <!-- Panel Voting -->
    <div id="panel-voting" class="hidden card text-left">
      <h2 class="text-xl font-semibold mb-4">Pilih Kandidat</h2>
      <div>
        <h3 class="font-bold mb-2">Kandidat OSIS</h3>
        <div id="vote-osis" class="space-y-2 mb-4"></div>

        <h3 class="font-bold mb-2">Kandidat MPK</h3>
        <div id="vote-mpk" class="space-y-2 mb-4"></div>
      </div>
      <button onclick="kirimVote()" class="btn bg-blue-600 text-white w-full">Kirim Suara</button>
    </div>

  </div>

  <script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAd5ShAKU-cWuA81pRp9PHbEEDijBGeog_F6vj4jUezcTvN-DfIumKWyg9StF3si1a/exec";

  let data = { candidates: [], voters: [], votes: [] };
  let currentVoter = null;

  // --- Fungsi utama ---
  async function loadData() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get_all`);
      const json = await res.json();
      if (json.status === "ok") data = json.data;
      console.log("Data loaded:", data);
    } catch (e) {
      alert("‚ö†Ô∏è Gagal memuat data online. Menggunakan data lokal.");
    }
  }

  async function importDataServer() {
    try {
      const res = await fetch(`${SCRIPT_URL}?action=get_all`);
      const json = await res.json();
      if (json.status === "ok") {
        data = json.data;
        renderAdmin();
        alert("‚úÖ Data berhasil diimpor dari server!");
      } else {
        alert("‚ùå Gagal memuat data dari server.");
      }
    } catch (e) {
      alert("‚ö†Ô∏è Gagal koneksi ke server. Pastikan internet aktif.");
    }
  }

  async function simpanSetup() {
    try {
      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "save_candidates", candidates: data.candidates })
      });
      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "save_voters", voters: data.voters })
      });
      alert("‚úÖ Berhasil simpan ke server dan lokal!");
    } catch (err) {
      alert("‚ùå Gagal simpan ke server. Data tetap tersimpan lokal.");
    }
  }

  // --- Navigasi antar panel ---
  function bukaAdmin() {
    hideAll();
    document.getElementById("panel-admin").classList.remove("hidden");
    renderAdmin();
  }

  function bukaPemilih() {
    hideAll();
    document.getElementById("panel-pemilih").classList.remove("hidden");
  }

  function kembaliMenu() {
    hideAll();
    document.getElementById("menu-awal").classList.remove("hidden");
  }

  function hideAll() {
    ["menu-awal","panel-admin","panel-pemilih","panel-voting"]
      .forEach(id => document.getElementById(id).classList.add("hidden"));
  }

  // --- Fungsi Admin ---
  function tambahOSIS() {
    const id = Date.now();
    data.candidates.push({ id, type: "osis", name: "Kandidat OSIS " + id, ketua: "", wakil: "", visi: "", photo: "", color: "#007bff" });
    renderAdmin();
  }

  function tambahMPK() {
    const id = Date.now();
    data.candidates.push({ id, type: "mpk", name: "Kandidat MPK " + id, ketua: "", wakil: "", visi: "", photo: "", color: "#28a745" });
    renderAdmin();
  }

  function tambahPemilih() {
    const id = Date.now();
    const kode = "K" + Math.random().toString(36).substring(2,7).toUpperCase();
    data.voters.push({ id, name: "Nama", class: "", nis: "", votingCode: kode, hasVoted: false });
    renderAdmin();
  }

  function renderAdmin() {
    const osis = data.candidates.filter(c => c.type === "osis");
    const mpk = data.candidates.filter(c => c.type === "mpk");

    document.getElementById("list-osis").innerHTML = osis.map(c => `<div class='p-2 border rounded'>${c.name}</div>`).join("");
    document.getElementById("list-mpk").innerHTML = mpk.map(c => `<div class='p-2 border rounded'>${c.name}</div>`).join("");
    document.getElementById("list-pemilih").innerHTML = data.voters.map(v => `<div class='p-2 border rounded'>${v.name} ‚Äî ${v.votingCode}</div>`).join("");
  }

  // --- Fungsi Pemilih ---
  function loginPemilih() {
    const kode = document.getElementById("kode-voting").value.trim();
    const voter = data.voters.find(v => v.votingCode === kode && !v.hasVoted);
    if (!voter) return alert("Kode tidak valid atau sudah digunakan.");
    currentVoter = voter;
    renderVoting();
  }

  function renderVoting() {
    hideAll();
    document.getElementById("panel-voting").classList.remove("hidden");
    const osis = data.candidates.filter(c => c.type === "osis");
    const mpk = data.candidates.filter(c => c.type === "mpk");
    document.getElementById("vote-osis").innerHTML = osis.map(c => `<label><input type='radio' name='osis' value='${c.name}'> ${c.name}</label>`).join("<br>");
    document.getElementById("vote-mpk").innerHTML = mpk.map(c => `<label><input type='radio' name='mpk' value='${c.name}'> ${c.name}</label>`).join("<br>");
  }

  async function kirimVote() {
    const osis = document.querySelector("input[name='osis']:checked");
    const mpk = document.querySelector("input[name='mpk']:checked");
    if (!osis || !mpk) return alert("Pilih kandidat OSIS dan MPK!");

    const payload = {
      action: "add_vote",
      voter_id: currentVoter.id,
      name: currentVoter.name,
      class: currentVoter.class,
      nis: currentVoter.nis,
      osis_candidate: osis.value,
      mpk_candidate: mpk.value,
      device_id: navigator.userAgent
    };

    try {
      await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      alert("‚úÖ Suara berhasil dikirim!");
      kembaliMenu();
    } catch (err) {
      alert("‚ùå Gagal kirim suara.");
    }
  }

  // --- Load awal ---
  loadData();
  </script>
</body>
</html>
